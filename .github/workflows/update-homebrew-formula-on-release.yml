name: Update Homebrew Formula On Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag to publish into Formula (e.g. v0.0.1-beta.8). Empty = latest release."
        required: false
        type: string

permissions:
  contents: write

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Compute source tarball checksum
        id: source
        env:
          REPOSITORY: ${{ github.repository }}
          EVENT_TAG_NAME: ${{ github.event.release.tag_name }}
          INPUT_TAG_NAME: ${{ github.event.inputs.tag_name }}
        run: |
          set -euo pipefail

          tag_name="${INPUT_TAG_NAME:-}"
          if [[ -z "${tag_name}" ]]; then
            tag_name="${EVENT_TAG_NAME:-}"
          fi

          if [[ -z "${tag_name}" ]]; then
            echo "No tag provided by event; resolving latest release tag..."
            tag_name="$(curl -fsSL "https://api.github.com/repos/${REPOSITORY}/releases/latest" \
              | python -c 'import json,sys; print(json.load(sys.stdin).get("tag_name",""))')"
          fi

          if [[ -z "${tag_name}" ]]; then
            echo "Unable to resolve release tag_name." >&2
            exit 1
          fi
          if [[ "${tag_name}" != v* ]]; then
            echo "Tag must start with 'v': ${tag_name}" >&2
            exit 1
          fi

          url="https://github.com/${REPOSITORY}/archive/refs/tags/${tag_name}.tar.gz"
          curl -fL --retry 5 --retry-delay 2 --retry-all-errors "$url" -o source.tar.gz
          sha256=$(sha256sum source.tar.gz | awk '{print $1}')
          version="${tag_name#v}"

          echo "Resolved release metadata:"
          echo "  repository=${REPOSITORY}"
          echo "  tag_name=${tag_name}"
          echo "  version=${version}"
          echo "  tarball_url=${url}"
          echo "  sha256=${sha256}"

          echo "tag_name=$tag_name" >> "$GITHUB_OUTPUT"
          echo "url=$url" >> "$GITHUB_OUTPUT"
          echo "sha256=$sha256" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Update Formula/moonshine-flow.rb
        env:
          TAG_NAME: ${{ steps.source.outputs.tag_name }}
          URL: ${{ steps.source.outputs.url }}
          SHA256: ${{ steps.source.outputs.sha256 }}
          VERSION: ${{ steps.source.outputs.version }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os
          from pathlib import Path

          path = Path("Formula/moonshine-flow.rb")
          content = path.read_text(encoding="utf-8")

          start_marker = "  # stable-release-start\n"
          end_marker = "  # stable-release-end\n"
          start = content.find(start_marker)
          end = content.find(end_marker)

          if start == -1 or end == -1 or end < start:
              raise RuntimeError("Stable release markers not found in Formula/moonshine-flow.rb")

          replacement = (
              start_marker
              + f'  url "{os.environ["URL"]}"\n'
              + f'  sha256 "{os.environ["SHA256"]}"\n'
              + f'  version "{os.environ["VERSION"]}"\n'
              + end_marker
          )

          updated = content[:start] + replacement + content[end + len(end_marker):]
          path.write_text(updated, encoding="utf-8")
          PY

          echo "Updated Formula stable block for ${TAG_NAME}:"
          sed -n '/# stable-release-start/,/# stable-release-end/p' Formula/moonshine-flow.rb

      - name: Validate formula syntax
        run: ruby -c Formula/moonshine-flow.rb

      - name: Inspect git state
        run: |
          set -euo pipefail
          git remote -v
          git status --short
          git diff -- Formula/moonshine-flow.rb || true

      - name: Commit and push if changed
        env:
          TAG_NAME: ${{ steps.source.outputs.tag_name }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          if git diff --quiet -- Formula/moonshine-flow.rb; then
            echo "No formula changes detected"
            exit 0
          fi

          git add Formula/moonshine-flow.rb
          GIT_AUTHOR_NAME="github-actions[bot]" \
          GIT_AUTHOR_EMAIL="41898282+github-actions[bot]@users.noreply.github.com" \
          GIT_COMMITTER_NAME="github-actions[bot]" \
          GIT_COMMITTER_EMAIL="41898282+github-actions[bot]@users.noreply.github.com" \
          git commit -m "chore(formula): update Homebrew formula for ${TAG_NAME}"
          git push origin "HEAD:${DEFAULT_BRANCH}"
